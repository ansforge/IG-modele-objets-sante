<!-- Script pour les contrôles SVG interactifs -->
<script>
(function() {
  // Attendre que le DOM soit complètement chargé
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAllSvgWrappers);
  } else {
    initAllSvgWrappers();
  }

  function initAllSvgWrappers() {
    // Initialiser tous les wrappers SVG sur la page
    const wrappers = document.querySelectorAll('.svg-wrap');
    wrappers.forEach(wrap => initSvgWrapper(wrap));
  }

  function initSvgWrapper(wrap) {
    if (!wrap) return;

    // Trouver le SVG inclus
    const svg = wrap.querySelector('svg');
    if (!svg) {
      console.warn('SVG non trouvé dans', wrap);
      return;
    }

    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    const zoomStep = 0.15;
    const minScale = 0.3;
    const maxScale = 5;
    const panSpeed = 1;

    let isPanning = false;
    let startX = 0;
    let startY = 0;

    function applyTransform() {
      svg.style.transformOrigin = "center center";
      svg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }

    // Récupérer les boutons de contrôle pour ce wrapper spécifique
    const zoomInBtn = wrap.querySelector('.svg-zoom-in');
    const zoomOutBtn = wrap.querySelector('.svg-zoom-out');
    const zoomResetBtn = wrap.querySelector('.svg-zoom-reset');
    const fsBtn = wrap.querySelector('.svg-fullscreen');

    /* ZOOM PAR BOUTONS */
    if (zoomInBtn) {
      zoomInBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        scale = Math.min(maxScale, scale + zoomStep);
        applyTransform();
      });
    }

    if (zoomOutBtn) {
      zoomOutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        scale = Math.max(minScale, scale - zoomStep);
        applyTransform();
      });
    }

    if (zoomResetBtn) {
      zoomResetBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        scale = 1;
        translateX = 0;
        translateY = 0;
        applyTransform();
      });
    }

    /* ZOOM À LA MOLETTE */
    wrap.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = e.deltaY < 0 ? zoomStep : -zoomStep;
      scale = Math.min(maxScale, Math.max(minScale, scale + delta));
      applyTransform();
    }, { passive: false });

    /* PAN (déplacement à la souris) */
    wrap.addEventListener('mousedown', (e) => {
      // Ignorer si clic sur les boutons de contrôle
      if (e.target.closest('.svg-controls')) return;

      // Ignorer si clic sur un lien ou élément cliquable dans le SVG
      if (e.target.tagName === 'A' || e.target.closest('a')) return;
      if (e.target.hasAttribute('href') || e.target.getAttribute('xlink:href')) return;

      // Ignorer si ce n'est pas le bouton gauche
      if (e.button !== 0) return;

      e.preventDefault();
      isPanning = true;
      startX = e.clientX - (translateX / panSpeed);
      startY = e.clientY - (translateY / panSpeed);
      wrap.classList.add('grabbing');
    });

    document.addEventListener('mousemove', (e) => {
      if (!isPanning) return;
      e.preventDefault();
      const deltaX = (e.clientX - startX) * panSpeed;
      const deltaY = (e.clientY - startY) * panSpeed;
      translateX = deltaX;
      translateY = deltaY;
      applyTransform();
    });

    document.addEventListener('mouseup', (e) => {
      if (isPanning) {
        isPanning = false;
        wrap.classList.remove('grabbing');
      }
    });

    document.addEventListener('mouseleave', () => {
      if (isPanning) {
        isPanning = false;
        wrap.classList.remove('grabbing');
      }
    });

    /* PINCH ZOOM (mobile) */
    let touchDistance = null;
    let lastTouchX = 0;
    let lastTouchY = 0;

    wrap.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) {
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        touchDistance = Math.sqrt(dx*dx + dy*dy);

        lastTouchX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
        lastTouchY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
      } else if (e.touches.length === 1) {
        lastTouchX = e.touches[0].clientX;
        lastTouchY = e.touches[0].clientY;
      }
    });

    wrap.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();

        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const newDist = Math.sqrt(dx*dx + dy*dy);

        if (touchDistance) {
          const diff = newDist - touchDistance;
          scale += diff * 0.005;
          scale = Math.min(maxScale, Math.max(minScale, scale));
          applyTransform();
        }

        touchDistance = newDist;
      } else if (e.touches.length === 1 && scale > 1) {
        e.preventDefault();
        const touchX = e.touches[0].clientX;
        const touchY = e.touches[0].clientY;

        translateX += touchX - lastTouchX;
        translateY += touchY - lastTouchY;
        applyTransform();

        lastTouchX = touchX;
        lastTouchY = touchY;
      }
    }, { passive: false });

    wrap.addEventListener('touchend', () => {
      touchDistance = null;
    });

    /* FULLSCREEN */
    if (fsBtn) {
      fsBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        try {
          if (!document.fullscreenElement) {
            // Réinitialiser zoom/pan avant fullscreen
            scale = 1;
            translateX = 0;
            translateY = 0;
            applyTransform();
            await wrap.requestFullscreen();
          } else {
            await document.exitFullscreen();
          }
        } catch (err) {
          console.error('Erreur fullscreen:', err);
        }
      });
    }

    // Pas besoin de gérer fullscreenchange car le CSS :fullscreen gère automatiquement l'affichage
  }
})();
</script>
